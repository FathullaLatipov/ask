# –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## üìä ER-–¥–∏–∞–≥—Ä–∞–º–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Users     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Departments ‚îÇ         ‚îÇ  WorkSchedules‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ                        ‚îÇ                        ‚îÇ
      ‚îÇ                        ‚îÇ                        ‚îÇ
      ‚ñº                        ‚ñº                        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Attendance  ‚îÇ         ‚îÇ  FacePhotos  ‚îÇ         ‚îÇ  WorkLocations‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Penalties ‚îÇ         ‚îÇ   Requests   ‚îÇ         ‚îÇ   Salaries  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìã –¢–∞–±–ª–∏—Ü—ã

### 1. users (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    telegram_id BIGINT UNIQUE,
    email VARCHAR(255) UNIQUE,
    phone VARCHAR(20),
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    middle_name VARCHAR(100),
    password_hash VARCHAR(255), -- –¥–ª—è Web Dashboard
    role VARCHAR(20) NOT NULL DEFAULT 'employee', -- employee, manager, admin
    department_id INTEGER REFERENCES departments(id),
    position VARCHAR(100),
    salary_type VARCHAR(20) NOT NULL DEFAULT 'hourly', -- fixed, hourly
    hourly_rate DECIMAL(10,2), -- –ø–æ—á–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞
    fixed_salary DECIMAL(10,2), -- —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ó–ü
    work_schedule_id INTEGER REFERENCES work_schedules(id),
    is_active BOOLEAN DEFAULT true,
    hire_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_telegram_id ON users(telegram_id);
CREATE INDEX idx_users_department_id ON users(department_id);
CREATE INDEX idx_users_role ON users(role);
```

**–ü–æ–ª—è:**
- `telegram_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `role` - —Ä–æ–ª—å: employee, manager, admin
- `salary_type` - —Ç–∏–ø –æ–ø–ª–∞—Ç—ã: fixed (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è), hourly (–ø–æ—á–∞—Å–æ–≤–∞—è)
- `work_schedule_id` - –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã

### 2. departments (–û—Ç–¥–µ–ª—ã)

```sql
CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    manager_id INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_departments_manager ON departments(manager_id);
```

**–û—Ç–¥–µ–ª—ã:**
- –ü—Ä–æ–¥–∞–∂–∞
- –ö–∞—Å—Å–∞
- –û—Ö—Ä–∞–Ω–∞
- –°–∫–ª–∞–¥
- –°–Ω–∞–±–∂–µ–Ω–∏–µ
- –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è
- –ü—Ä–æ—á–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏

### 3. work_schedules (–ì—Ä–∞—Ñ–∏–∫–∏ —Ä–∞–±–æ—Ç—ã)

```sql
CREATE TABLE work_schedules (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    start_time TIME NOT NULL, -- –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã
    end_time TIME NOT NULL, -- –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã
    break_duration INTEGER DEFAULT 60, -- –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ä—ã–≤–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
    work_days INTEGER[] NOT NULL, -- –º–∞—Å—Å–∏–≤ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ [1,2,3,4,5] = –ü–Ω-–ü—Ç
    late_threshold INTEGER DEFAULT 15, -- –ø–æ—Ä–æ–≥ –æ–ø–æ–∑–¥–∞–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫: 09:00-18:00, –ü–Ω-–ü—Ç
- –°–º–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫: 08:00-20:00, —á–µ—Ä–µ–∑ –¥–µ–Ω—å

### 4. work_locations (–†–∞–±–æ—á–∏–µ –ª–æ–∫–∞—Ü–∏–∏)

```sql
CREATE TABLE work_locations (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    address TEXT,
    latitude DECIMAL(10,8) NOT NULL,
    longitude DECIMAL(11,8) NOT NULL,
    radius INTEGER DEFAULT 100, -- —Ä–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö
    department_id INTEGER REFERENCES departments(id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_work_locations_coords ON work_locations(latitude, longitude);
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–¥–∏—É—Å–µ —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞

### 5. face_photos (–≠—Ç–∞–ª–æ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ –¥–ª—è Face ID)

```sql
CREATE TABLE face_photos (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    photo_url VARCHAR(500) NOT NULL, -- –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    encoding TEXT, -- –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–∞ (JSON)
    is_primary BOOLEAN DEFAULT false, -- –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_face_photos_user ON face_photos(user_id);
```

**–õ–æ–≥–∏–∫–∞:**
- –û–¥–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ (`is_primary = true`)
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏

### 6. attendance (–£—á–µ—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)

```sql
CREATE TABLE attendance (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    checkin_time TIMESTAMP NOT NULL,
    checkout_time TIMESTAMP,
    checkin_photo_url VARCHAR(500),
    checkout_photo_url VARCHAR(500),
    checkin_latitude DECIMAL(10,8),
    checkin_longitude DECIMAL(11,8),
    checkout_latitude DECIMAL(10,8),
    checkout_longitude DECIMAL(11,8),
    work_location_id INTEGER REFERENCES work_locations(id),
    is_late BOOLEAN DEFAULT false,
    late_minutes INTEGER DEFAULT 0,
    face_verified BOOLEAN DEFAULT false, -- –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è Face ID
    location_verified BOOLEAN DEFAULT false, -- –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    total_hours DECIMAL(5,2), -- –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —á–∞—Å—ã
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_attendance_user ON attendance(user_id);
CREATE INDEX idx_attendance_date ON attendance(checkin_time);
CREATE INDEX idx_attendance_user_date ON attendance(user_id, checkin_time);
```

**–õ–æ–≥–∏–∫–∞:**
- –û–¥–Ω–∞ –∑–∞–ø–∏—Å—å = –æ–¥–∏–Ω —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
- `checkout_time` NULL = —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –µ—â–µ –Ω–∞ —Ä–∞–±–æ—Ç–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç `total_hours` –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ

### 7. penalties (–®—Ç—Ä–∞—Ñ—ã)

```sql
CREATE TABLE penalties (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    attendance_id INTEGER REFERENCES attendance(id),
    penalty_type VARCHAR(50) NOT NULL, -- late, absence, violation
    amount DECIMAL(10,2) NOT NULL,
    description TEXT,
    period DATE NOT NULL, -- –ø–µ—Ä–∏–æ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (–≥–æ–¥-–º–µ—Å—è—Ü)
    status VARCHAR(20) DEFAULT 'active', -- active, cancelled
    created_by INTEGER REFERENCES users(id), -- –∫—Ç–æ —Å–æ–∑–¥–∞–ª
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_penalties_user ON penalties(user_id);
CREATE INDEX idx_penalties_period ON penalties(period);
```

**–¢–∏–ø—ã —à—Ç—Ä–∞—Ñ–æ–≤:**
- `late` - –æ–ø–æ–∑–¥–∞–Ω–∏–µ
- `absence` - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–µ–∑ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã
- `violation` - –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª

### 8. requests (–ó–∞—è–≤–∫–∏)

```sql
CREATE TABLE requests (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    request_type VARCHAR(50) NOT NULL, -- vacation, sick_leave, day_off, advance
    start_date DATE NOT NULL,
    end_date DATE, -- NULL –¥–ª—è –æ–¥–Ω–æ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫
    amount DECIMAL(10,2), -- –¥–ª—è –∞–≤–∞–Ω—Å–∞
    reason TEXT,
    status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected
    reviewed_by INTEGER REFERENCES users(id), -- –∫—Ç–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª
    reviewed_at TIMESTAMP,
    review_comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_requests_user ON requests(user_id);
CREATE INDEX idx_requests_status ON requests(status);
CREATE INDEX idx_requests_dates ON requests(start_date, end_date);
```

**–¢–∏–ø—ã –∑–∞—è–≤–æ–∫:**
- `vacation` - –æ—Ç–ø—É—Å–∫
- `sick_leave` - –±–æ–ª—å–Ω–∏—á–Ω—ã–π
- `day_off` - –≤—ã—Ö–æ–¥–Ω–æ–π (–æ—Ç–≥—É–ª)
- `advance` - –∞–≤–∞–Ω—Å

### 9. salaries (–ó–∞—Ä–∞–±–æ—Ç–Ω–∞—è –ø–ª–∞—Ç–∞)

```sql
CREATE TABLE salaries (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    period DATE NOT NULL, -- –ø–µ—Ä–∏–æ–¥ (–≥–æ–¥-–º–µ—Å—è—Ü)
    base_hours DECIMAL(6,2) NOT NULL, -- –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —á–∞—Å—ã
    base_amount DECIMAL(10,2) NOT NULL, -- –±–∞–∑–æ–≤–∞—è —Å—É–º–º–∞
    overtime_hours DECIMAL(6,2) DEFAULT 0, -- –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏
    overtime_amount DECIMAL(10,2) DEFAULT 0,
    penalties_amount DECIMAL(10,2) DEFAULT 0, -- —Å—É–º–º–∞ —à—Ç—Ä–∞—Ñ–æ–≤
    advances_amount DECIMAL(10,2) DEFAULT 0, -- —Å—É–º–º–∞ –∞–≤–∞–Ω—Å–æ–≤
    total_amount DECIMAL(10,2) NOT NULL, -- –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞
    status VARCHAR(20) DEFAULT 'calculated', -- calculated, paid
    paid_at TIMESTAMP,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, period)
);

CREATE INDEX idx_salaries_user ON salaries(user_id);
CREATE INDEX idx_salaries_period ON salaries(period);
```

**–†–∞—Å—á–µ—Ç:**
```
total_amount = base_amount + overtime_amount - penalties_amount - advances_amount
```

### 10. salary_calculations (–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –ó–ü)

```sql
CREATE TABLE salary_calculations (
    id SERIAL PRIMARY KEY,
    salary_id INTEGER NOT NULL REFERENCES salaries(id) ON DELETE CASCADE,
    calculation_type VARCHAR(50) NOT NULL, -- base, overtime, penalty, advance
    description TEXT,
    amount DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_salary_calculations_salary ON salary_calculations(salary_id);
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –ó–ü
- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞

### 11. system_settings (–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã)

```sql
CREATE TABLE system_settings (
    id SERIAL PRIMARY KEY,
    key VARCHAR(100) UNIQUE NOT NULL,
    value TEXT NOT NULL,
    description TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
- `penalty_late_per_minute` - —à—Ç—Ä–∞—Ñ –∑–∞ –º–∏–Ω—É—Ç—É –æ–ø–æ–∑–¥–∞–Ω–∏—è
- `penalty_absence` - —à—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ
- `overtime_multiplier` - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ (1.5, 2.0)
- `face_verification_threshold` - –ø–æ—Ä–æ–≥ —Ç–æ—á–Ω–æ—Å—Ç–∏ Face ID

### 12. audit_log (–ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞)

```sql
CREATE TABLE audit_log (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    action VARCHAR(100) NOT NULL,
    entity_type VARCHAR(50),
    entity_id INTEGER,
    old_values JSONB,
    new_values JSONB,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_log_user ON audit_log(user_id);
CREATE INDEX idx_audit_log_created ON audit_log(created_at);
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–∞–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

## üîÑ –¢—Ä–∏–≥–≥–µ—Ä—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —á–∞—Å–æ–≤

```sql
CREATE OR REPLACE FUNCTION calculate_work_hours()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.checkout_time IS NOT NULL AND NEW.checkin_time IS NOT NULL THEN
        NEW.total_hours := EXTRACT(EPOCH FROM (NEW.checkout_time - NEW.checkin_time)) / 3600;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_calculate_hours
BEFORE UPDATE ON attendance
FOR EACH ROW
WHEN (NEW.checkout_time IS NOT NULL AND OLD.checkout_time IS NULL)
EXECUTE FUNCTION calculate_work_hours();
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø–æ–∑–¥–∞–Ω–∏—è

```sql
CREATE OR REPLACE FUNCTION check_late()
RETURNS TRIGGER AS $$
DECLARE
    schedule_start TIME;
    late_threshold INTEGER;
    checkin_time_only TIME;
BEGIN
    SELECT ws.start_time, ws.late_threshold
    INTO schedule_start, late_threshold
    FROM users u
    JOIN work_schedules ws ON u.work_schedule_id = ws.id
    WHERE u.id = NEW.user_id;
    
    checkin_time_only := NEW.checkin_time::TIME;
    
    IF checkin_time_only > (schedule_start + (late_threshold || ' minutes')::INTERVAL) THEN
        NEW.is_late := true;
        NEW.late_minutes := EXTRACT(EPOCH FROM (checkin_time_only - schedule_start)) / 60;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_check_late
BEFORE INSERT ON attendance
FOR EACH ROW
EXECUTE FUNCTION check_late();
```

## üìä –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views)

### –¢–µ–∫—É—â–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–∞ —Ä–∞–±–æ—Ç–µ

```sql
CREATE VIEW active_employees AS
SELECT 
    u.id,
    u.first_name || ' ' || u.last_name AS full_name,
    d.name AS department,
    a.checkin_time,
    a.checkin_latitude,
    a.checkin_longitude,
    EXTRACT(EPOCH FROM (NOW() - a.checkin_time)) / 3600 AS hours_worked
FROM attendance a
JOIN users u ON a.user_id = u.id
JOIN departments d ON u.department_id = d.id
WHERE a.checkout_time IS NULL
AND DATE(a.checkin_time) = CURRENT_DATE;
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º

```sql
CREATE VIEW department_stats AS
SELECT 
    d.id,
    d.name,
    COUNT(DISTINCT u.id) AS total_employees,
    COUNT(DISTINCT CASE WHEN a.checkout_time IS NULL THEN u.id END) AS active_now,
    AVG(a.total_hours) AS avg_hours_per_day
FROM departments d
LEFT JOIN users u ON d.id = u.department_id
LEFT JOIN attendance a ON u.id = a.user_id 
    AND DATE(a.checkin_time) = CURRENT_DATE
GROUP BY d.id, d.name;
```

## üîç –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```sql
-- –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_attendance_user_date ON attendance(user_id, DATE(checkin_time));
CREATE INDEX idx_attendance_period ON attendance(DATE_TRUNC('month', checkin_time));
CREATE INDEX idx_salaries_user_period ON salaries(user_id, period);
CREATE INDEX idx_requests_user_status ON requests(user_id, status);
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –ø–∞—Ä–æ–ª–∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è (bcrypt)
- –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ñ–æ—Ç–æ, –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è) —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –±—ç–∫–∞–ø—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

