# –õ–æ–≥–∏–∫–∞ Face ID –∏ –ì–µ–æ–ª–æ–∫–∞—Ü–∏–∏

## üì∏ Face ID (–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ª–∏—Ü)

### –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

Face ID –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–∏—á–Ω–æ—Å—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø—Ä–∏—Ö–æ–¥–∞ –∏ —É—Ö–æ–¥–∞. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å —É—á–µ—Ç–∞ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Python 3.9+**
- **FastAPI** - –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **face_recognition** - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ª–∏—Ü (–æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ dlib)
- **OpenCV** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **NumPy** - –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- **Pillow** - —Ä–∞–±–æ—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Face ID —Å–µ—Ä–≤–∏—Å–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  REST API   ‚îÇ
‚îÇ   (Backend) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ HTTP
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Face ID     ‚îÇ
‚îÇ  Service    ‚îÇ
‚îÇ (FastAPI)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îê
   ‚ñº       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  DB  ‚îÇ ‚îÇ  Storage ‚îÇ
‚îÇ      ‚îÇ ‚îÇ  (S3)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ

1. **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ**
   - –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ Telegram Bot –∏–ª–∏ Web Dashboard
   - –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (S3, –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
   - –ü–æ–ª—É—á–∞–µ–º URL —Ñ–æ—Ç–æ

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ**
   ```python
   def process_photo(photo_url):
       # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
       image = face_recognition.load_image_file(photo_url)
       
       # –ü–æ–∏—Å–∫ –ª–∏—Ü –Ω–∞ —Ñ–æ—Ç–æ
       face_locations = face_recognition.face_locations(image)
       
       if len(face_locations) == 0:
           raise ValueError("–õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ")
       
       if len(face_locations) > 1:
           raise ValueError("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–∏—Ü")
       
       # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –ª–∏—Ü–∞
       face_encodings = face_recognition.face_encodings(image, face_locations)
       encoding = face_encodings[0]
       
       return encoding.tolist()  # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è JSON
   ```

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î**
   - –°–æ—Ö—Ä–∞–Ω—è–µ–º URL —Ñ–æ—Ç–æ
   - –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–∞ (encoding)
   - –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ (`is_primary = true`)

### –ü—Ä–æ—Ü–µ—Å—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞**
   ```json
   {
     "user_id": 1,
     "photo_url": "https://storage.example.com/temp/checkin_123.jpg",
     "check_type": "checkin"
   }
   ```

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏**
   ```python
   def verify_face(user_id, photo_url):
       # –ó–∞–≥—Ä—É–∑–∫–∞ —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ –∏–∑ –ë–î
       reference_photo = get_reference_photo(user_id)
       reference_encoding = np.array(reference_photo.encoding)
       
       # –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ç–æ
       image = face_recognition.load_image_file(photo_url)
       face_locations = face_recognition.face_locations(image)
       
       if len(face_locations) == 0:
           return {
               "verified": False,
               "confidence": 0.0,
               "message": "–õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ"
           }
       
       face_encoding = face_recognition.face_encodings(image, face_locations)[0]
       
       # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ª–∏—Ü
       distance = face_recognition.face_distance([reference_encoding], face_encoding)[0]
       confidence = 1 - distance  # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –≤ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
       
       # –ü–æ—Ä–æ–≥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ system_settings)
       threshold = get_setting("face_verification_threshold", 0.6)
       
       verified = confidence >= threshold
       
       return {
           "verified": verified,
           "confidence": float(confidence),
           "message": "–õ–∏—Ü–æ —É—Å–ø–µ—à–Ω–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ" if verified else "–õ–∏—Ü–æ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç"
       }
   ```

3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**
   - –ï—Å–ª–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ ‚Üí Backend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–º–µ—Ç–∫—É
   - –ï—Å–ª–∏ –Ω–µ—É—Å–ø–µ—à–Ω–∞ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞, –æ—Ç–º–µ—Ç–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ**
   - –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è encoding

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å–≤–µ—â–µ–Ω–∏—è –∏ —É–≥–ª–æ–≤**
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ü–æ–≤—ã—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
   - –û–±—Ä–µ–∑–∫–∞ –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ª–∏—Ü–∞

3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ encoding**
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö encoding –≤ Redis
   - –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

4. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Celery –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫

### API Endpoints

**POST** `/verify`
```python
@app.post("/verify")
async def verify(request: VerifyRequest):
    result = verify_face(request.user_id, request.photo_url)
    return result
```

**POST** `/register`
```python
@app.post("/register")
async def register(request: RegisterRequest):
    encoding = process_photo(request.photo_url)
    save_reference_photo(request.user_id, request.photo_url, encoding)
    return {"success": True}
```

**GET** `/health`
```python
@app.get("/health")
async def health():
    return {"status": "ok", "version": "1.0.0"}
```

---

## üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è

### –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø—Ä–∏—Ö–æ–¥–∞/—É—Ö–æ–¥–∞. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—É—é –æ—Ç–º–µ—Ç–∫—É –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è.

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Haversine —Ñ–æ—Ä–º—É–ª–∞** - —Ä–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
- **PostgreSQL** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞
- **PostGIS** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –¥–ª—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö –≥–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç**
   - Telegram Bot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ
   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Backend

2. **–ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–π —Ä–∞–±–æ—á–µ–π –ª–æ–∫–∞—Ü–∏–∏**
   ```python
   def find_nearest_location(user_id, latitude, longitude):
       # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–¥–µ–ª —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
       user = get_user(user_id)
       department_id = user.department_id
       
       # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–±–æ—á–∏–µ –ª–æ–∫–∞—Ü–∏–∏ –æ—Ç–¥–µ–ª–∞
       locations = get_work_locations(department_id)
       
       min_distance = float('inf')
       nearest_location = None
       
       for location in locations:
           distance = haversine_distance(
               (latitude, longitude),
               (location.latitude, location.longitude)
           )
           
           if distance < min_distance:
               min_distance = distance
               nearest_location = location
       
       return nearest_location, min_distance
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–¥–∏—É—Å–∞**
   ```python
   def verify_location(user_id, latitude, longitude):
       nearest_location, distance = find_nearest_location(
           user_id, latitude, longitude
       )
       
       if nearest_location is None:
           return {
               "verified": False,
               "message": "–†–∞–±–æ—á–∞—è –ª–æ–∫–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
           }
       
       # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤ —Ä–∞–¥–∏—É—Å–µ
       if distance <= nearest_location.radius:
           return {
               "verified": True,
               "work_location": {
                   "id": nearest_location.id,
                   "name": nearest_location.name,
                   "distance": distance
               },
               "message": "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ"
           }
       else:
           return {
               "verified": False,
               "work_location": {
                   "id": nearest_location.id,
                   "name": nearest_location.name,
                   "distance": distance
               },
               "message": f"–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ ({distance:.0f}–º > {nearest_location.radius}–º)"
           }
   ```

### –§–æ—Ä–º—É–ª–∞ Haversine

```python
import math

def haversine_distance(coord1, coord2):
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ –Ω–∞ –ó–µ–º–ª–µ
    –≤ –º–µ—Ç—Ä–∞—Ö –ø–æ —Ñ–æ—Ä–º—É–ª–µ Haversine
    
    coord1, coord2: (latitude, longitude) –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
    """
    R = 6371000  # –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
    
    lat1, lon1 = math.radians(coord1[0]), math.radians(coord1[1])
    lat2, lon2 = math.radians(coord2[0]), math.radians(coord2[1])
    
    dlat = lat2 - lat1
    dlon = lon2 - lon1
    
    a = math.sin(dlat/2)**2 + math.cos(lat1) * math.cos(lat2) * math.sin(dlon/2)**2
    c = 2 * math.asin(math.sqrt(a))
    
    distance = R * c
    return distance
```

### SQL —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (PostgreSQL)

```sql
CREATE OR REPLACE FUNCTION check_location(
    p_user_id INTEGER,
    p_latitude DECIMAL,
    p_longitude DECIMAL
) RETURNS TABLE (
    location_id INTEGER,
    location_name VARCHAR,
    distance DECIMAL,
    verified BOOLEAN
) AS $$
DECLARE
    v_department_id INTEGER;
    v_location RECORD;
    v_distance DECIMAL;
    v_min_distance DECIMAL := 999999;
    v_nearest_location RECORD;
BEGIN
    -- –ü–æ–ª—É—á–∞–µ–º –æ—Ç–¥–µ–ª —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    SELECT department_id INTO v_department_id
    FROM users
    WHERE id = p_user_id;
    
    -- –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –ª–æ–∫–∞—Ü–∏—é
    FOR v_location IN
        SELECT id, name, latitude, longitude, radius
        FROM work_locations
        WHERE department_id = v_department_id
        AND is_active = true
    LOOP
        v_distance := (
            6371000 * acos(
                cos(radians(p_latitude)) *
                cos(radians(v_location.latitude)) *
                cos(radians(v_location.longitude) - radians(p_longitude)) +
                sin(radians(p_latitude)) *
                sin(radians(v_location.latitude))
            )
        );
        
        IF v_distance < v_min_distance THEN
            v_min_distance := v_distance;
            v_nearest_location := v_location;
        END IF;
    END LOOP;
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–¥–∏—É—Å
    IF v_nearest_location IS NOT NULL AND v_min_distance <= v_nearest_location.radius THEN
        RETURN QUERY SELECT
            v_nearest_location.id,
            v_nearest_location.name,
            v_min_distance,
            true;
    ELSE
        RETURN QUERY SELECT
            COALESCE(v_nearest_location.id, 0),
            COALESCE(v_nearest_location.name, '–ù–µ –Ω–∞–π–¥–µ–Ω–æ'),
            v_min_distance,
            false;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Bot

```javascript
// –í Telegram Bot
bot.command('checkin', async (ctx) => {
  // –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
  await ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é', {
    reply_markup: {
      keyboard: [[{
        text: 'üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é',
        request_location: true
      }]],
      resize_keyboard: true,
      one_time_keyboard: true
    }
  });
});

bot.on('location', async (ctx) => {
  const { latitude, longitude } = ctx.message.location;
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Backend
  const response = await fetch('https://api.example.com/api/geolocation/verify', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      user_id: ctx.from.id,
      latitude,
      longitude
    })
  });
  
  const result = await response.json();
  
  if (result.verified) {
    await ctx.reply(`‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞\nüìç ${result.work_location.name}\nüìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${result.work_location.distance.toFixed(0)}–º`);
  } else {
    await ctx.reply(`‚ùå ${result.message}`);
  }
});
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

1. **–ù–µ—Ç GPS —Å–∏–≥–Ω–∞–ª–∞**
   - –ü–æ–∑–≤–æ–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –≤–≤–µ—Å—Ç–∏ –∞–¥—Ä–µ—Å –≤—Ä—É—á–Ω—É—é
   - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—Ä—É—á–Ω—É—é

2. **–ù–µ—Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã**
   - –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–¥–∏—É—Å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
   - –£—á–∏—Ç—ã–≤–∞—Ç—å –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å GPS (–æ–±—ã—á–Ω–æ 5-10 –º–µ—Ç—Ä–æ–≤)

3. **–ù–µ—Å–∫–æ–ª—å–∫–æ –ª–æ–∫–∞—Ü–∏–π**
   - –í—ã–±–∏—Ä–∞—Ç—å –±–ª–∏–∂–∞–π—à—É—é
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
   - –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
   - –ù–µ –¥–æ–≤–µ—Ä—è—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º

2. **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram Location API (—Å–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å)
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∞—É–¥–∏—Ç–∞

3. **–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å**
   - –•—Ä–∞–Ω–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–º–µ—Ç–æ–∫
   - –ù–µ —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
   - –°–æ–±–ª—é–¥–∞—Ç—å GDPR/–∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–í `system_settings`:
- `location_verification_required` - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
- `location_radius_default` - —Ä–∞–¥–∏—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–º–µ—Ç—Ä—ã)
- `location_gps_tolerance` - –¥–æ–ø—É—Å—Ç–∏–º–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å GPS (–º–µ—Ç—Ä—ã)

---

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –æ–±—â–∏–π –ø–æ—Ç–æ–∫

### –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–º–µ—Ç–∫–∏ –ø—Ä–∏—Ö–æ–¥–∞

```
1. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ ‚Üí Telegram Bot: /checkin
2. Telegram Bot ‚Üí –°–æ—Ç—Ä—É–¥–Ω–∏–∫: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ"
3. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ ‚Üí Telegram Bot: –§–æ—Ç–æ
4. Telegram Bot ‚Üí Face ID Service: POST /verify
5. Face ID Service ‚Üí Telegram Bot: {verified: true, confidence: 0.95}
6. Telegram Bot ‚Üí –°–æ—Ç—Ä—É–¥–Ω–∏–∫: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é"
7. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ ‚Üí Telegram Bot: –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
8. Telegram Bot ‚Üí Backend: POST /api/geolocation/verify
9. Backend ‚Üí Telegram Bot: {verified: true, work_location: {...}}
10. Telegram Bot ‚Üí Backend: POST /api/attendance/checkin
    {
      photo_url: "...",
      face_verified: true,
      latitude: 55.7558,
      longitude: 37.6173,
      location_verified: true
    }
11. Backend ‚Üí Database: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
12. Backend ‚Üí WebSocket: –°–æ–±—ã—Ç–∏–µ employee:checkin
13. WebSocket ‚Üí Web Dashboard: Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- **Face ID –Ω–µ –ø—Ä–æ—à–µ–ª** ‚Üí –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
- **–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞** ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –∞–¥—Ä–µ—Å –≤—Ä—É—á–Ω—É—é
- **–û–±–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –ø—Ä–æ—à–ª–∏** ‚Üí –û—Ç–º–µ—Ç–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

