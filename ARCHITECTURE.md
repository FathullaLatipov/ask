# Архитектура системы

## 🏗️ Общая архитектура

Система построена по принципу микросервисной архитектуры с четким разделением ответственности.

```
┌─────────────────────────────────────────────────────────────┐
│                        Client Layer                          │
├─────────────────────┬───────────────────────────────────────┤
│   Telegram Bot      │         Web Dashboard             │
│   (Mobile/Desktop)  │         (Browser)                     │
└──────────┬──────────┴──────────────┬────────────────────────┘
           │                         │
           │ HTTPS                   │ HTTPS
           │                         │
┌──────────▼─────────────────────────▼────────────────────────┐
│                    API Gateway / Load Balancer              │
└──────────┬─────────────────────────┬────────────────────────┘
           │                         │
    ┌──────┴──────┐          ┌───────┴───────┐
    │             │          │               │
┌───▼────┐   ┌───▼────┐  ┌───▼────┐    ┌───▼────┐
│ REST   │   │WebSocket│  │Telegram│    │ Face ID│
│ API    │   │ Server  │  │  Bot   │    │Service │
│Service │   │         │  │Service │    │        │
└───┬────┘   └───┬────┘  └───┬────┘    └───┬────┘
    │            │           │             │
    └────────────┴───────────┴─────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
   ┌────▼────┐            ┌────▼────┐
   │PostgreSQL│            │  Redis  │
   │Database │            │  Cache  │
   └─────────┘            └─────────┘
```

## 📦 Компоненты системы

### 1. REST API Service (Backend)
**Технологии:** Node.js, Express, TypeScript

**Ответственность:**
- Обработка всех HTTP запросов
- Бизнес-логика системы
- Валидация данных
- Авторизация и аутентификация (JWT)
- Интеграция с базой данных
- Интеграция с внешними сервисами

**Основные модули:**
- `auth/` - аутентификация и авторизация
- `users/` - управление пользователями
- `attendance/` - учет рабочего времени
- `salary/` - расчет заработной платы
- `requests/` - заявки (отпуск, больничный, аванс)
- `departments/` - управление отделами
- `reports/` - отчетность
- `face-id/` - интеграция с Face ID сервисом
- `geolocation/` - обработка геолокации

### 2. WebSocket Server
**Технологии:** Node.js, Socket.io

**Ответственность:**
- Real-time обновления для Web Dashboard
- Push-уведомления о событиях
- Обновление статусов сотрудников в реальном времени

**События:**
- `employee:checkin` - сотрудник отметился
- `employee:checkout` - сотрудник ушел
- `employee:late` - опоздание
- `request:created` - создана заявка
- `request:approved` - заявка утверждена
- `request:rejected` - заявка отклонена

### 3. Telegram Bot Service
**Технологии:** Node.js, Telegraf

**Ответственность:**
- Интерфейс для сотрудников
- Прием команд (приход/уход)
- Запрос фото для Face ID
- Получение геолокации
- Отображение статистики
- Прием заявок

**Основные команды:**
- `/start` - начало работы
- `/checkin` - отметка прихода
- `/checkout` - отметка ухода
- `/status` - текущий статус
- `/stats` - статистика за период
- `/request` - подача заявки
- `/salary` - информация о ЗП

### 4. Face ID Service
**Технологии:** Python, FastAPI, OpenCV, Face Recognition

**Ответственность:**
- Обработка фотографий сотрудников
- Верификация личности
- Сравнение с эталонными фото
- Возврат результата верификации

**API:**
- `POST /verify` - верификация фото
- `POST /register` - регистрация эталонного фото
- `GET /health` - проверка здоровья сервиса

### 5. Database (PostgreSQL)
**Ответственность:**
- Хранение всех данных системы
- Транзакционная целостность
- Индексы для быстрого поиска

### 6. Redis Cache
**Ответственность:**
- Кэширование часто запрашиваемых данных
- Сессии пользователей
- Real-time данные (активные сотрудники)
- Очереди задач

## 🔄 Потоки данных

### Поток: Отметка прихода через Telegram Bot

```
1. Сотрудник → Telegram Bot: /checkin
2. Telegram Bot → REST API: POST /api/attendance/checkin
3. REST API → Telegram Bot: "Отправьте фото"
4. Сотрудник → Telegram Bot: Фото
5. Telegram Bot → Face ID Service: POST /verify
6. Face ID Service → Telegram Bot: Результат верификации
7. Telegram Bot → REST API: POST /api/attendance/checkin (с фото и геолокацией)
8. REST API → Database: Сохранение записи
9. REST API → WebSocket Server: Событие employee:checkin
10. WebSocket Server → Web Dashboard: Real-time обновление
```

### Поток: Real-time обновление дашборда

```
1. Web Dashboard → WebSocket Server: Подключение
2. WebSocket Server → Redis: Подписка на события
3. REST API → Redis: Публикация события
4. Redis → WebSocket Server: Событие
5. WebSocket Server → Web Dashboard: Обновление UI
```

### Поток: Расчет заработной платы

```
1. Администратор → Web Dashboard: Запрос расчета ЗП
2. Web Dashboard → REST API: GET /api/salary/calculate?period=2024-01
3. REST API → Database: Получение данных
   - Отработанные часы
   - Штрафы
   - Опоздания
   - Авансы
4. REST API → Бизнес-логика: Расчет по формуле
5. REST API → Database: Сохранение результата
6. REST API → Web Dashboard: Возврат данных
```

## 🔐 Безопасность

### Аутентификация
- **JWT токены** для REST API
- **Telegram User ID** для Telegram Bot
- **Session-based** для Web Dashboard

### Авторизация
- **RBAC (Role-Based Access Control)**
- Роли: Employee, Manager, Admin
- Middleware для проверки прав доступа

### Защита данных
- HTTPS для всех соединений
- Хеширование паролей (bcrypt)
- Валидация всех входных данных
- Rate limiting для API
- CORS настройки

## 📊 Масштабируемость

### Горизонтальное масштабирование
- REST API: Stateless, можно запускать несколько инстансов
- WebSocket Server: Использование Redis Adapter для кластеризации
- Database: Read replicas для чтения
- Redis: Redis Cluster для распределения

### Вертикальное масштабирование
- Оптимизация запросов к БД
- Индексы на часто используемых полях
- Кэширование в Redis
- Асинхронная обработка задач (Bull Queue)

## 🔄 Обработка ошибок

### Стратегия
- Централизованный error handler
- Логирование всех ошибок
- Уведомления администраторам о критических ошибках
- Graceful degradation при недоступности сервисов

### Мониторинг
- Health checks для всех сервисов
- Метрики производительности
- Логирование (Winston, Pino)
- Алерты при проблемах

## 📦 Деплой

### Docker контейнеризация
- Каждый сервис в отдельном контейнере
- Docker Compose для локальной разработки
- Kubernetes для продакшена

### CI/CD
- Автоматические тесты
- Автоматический деплой при merge в main
- Rollback механизм

## 🔌 Интеграции

### Внешние сервисы
- Telegram Bot API
- Email сервис (для уведомлений)
- SMS сервис (опционально)
- Системы бухгалтерского учета (опционально)

### Внутренние интеграции
- Face ID Service через HTTP
- WebSocket для real-time
- Redis для кэша и очередей
- PostgreSQL для данных

